

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z43R9PWW0B"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-Z43R9PWW0B');
    </script>
    
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>keeks.binary_strategies.simple &mdash; Keeks</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/dark_mode_css/general.css?v=c0a7eb24" />
      <link rel="stylesheet" type="text/css" href="../../../_static/dark_mode_css/dark.css?v=70edf1c7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=b1f64a84"></script>
      <script src="../../../_static/doctools.js?v=888ff710"></script>
      <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
      <script src="../../../_static/dark_mode_js/default_dark.js?v=fd565c74"></script>
      <script src="../../../_static/dark_mode_js/theme_switcher.js?v=358d3910"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #1a1a1a" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            keeks
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started.html#basic-usage">Basic Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started.html#using-different-strategies">Using Different Strategies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started.html#using-different-simulators">Using Different Simulators</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../binary_strategies.html">Binary Strategies</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../binary_strategies.html#base-strategy">Base Strategy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.base.BaseStrategy"><code class="docutils literal notranslate"><span class="pre">BaseStrategy</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.base.BaseStrategy.calculate_max_entry_price"><code class="docutils literal notranslate"><span class="pre">BaseStrategy.calculate_max_entry_price()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.base.BaseStrategy.evaluate"><code class="docutils literal notranslate"><span class="pre">BaseStrategy.evaluate()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.base.BaseStrategy.get_max_safe_bet"><code class="docutils literal notranslate"><span class="pre">BaseStrategy.get_max_safe_bet()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../binary_strategies.html#naive-strategy">Naive Strategy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.NaiveStrategy"><code class="docutils literal notranslate"><span class="pre">NaiveStrategy</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.NaiveStrategy.calculate_max_entry_price"><code class="docutils literal notranslate"><span class="pre">NaiveStrategy.calculate_max_entry_price()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.NaiveStrategy.evaluate"><code class="docutils literal notranslate"><span class="pre">NaiveStrategy.evaluate()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../binary_strategies.html#fixed-fraction-strategy">Fixed Fraction Strategy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.FixedFractionStrategy"><code class="docutils literal notranslate"><span class="pre">FixedFractionStrategy</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.FixedFractionStrategy.calculate_max_entry_price"><code class="docutils literal notranslate"><span class="pre">FixedFractionStrategy.calculate_max_entry_price()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.FixedFractionStrategy.evaluate"><code class="docutils literal notranslate"><span class="pre">FixedFractionStrategy.evaluate()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../binary_strategies.html#cppi-strategy">CPPI Strategy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.CPPIStrategy"><code class="docutils literal notranslate"><span class="pre">CPPIStrategy</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.CPPIStrategy.calculate_max_entry_price"><code class="docutils literal notranslate"><span class="pre">CPPIStrategy.calculate_max_entry_price()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.CPPIStrategy.evaluate"><code class="docutils literal notranslate"><span class="pre">CPPIStrategy.evaluate()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.CPPIStrategy.update_bankroll"><code class="docutils literal notranslate"><span class="pre">CPPIStrategy.update_bankroll()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../binary_strategies.html#dynamic-bankroll-management">Dynamic Bankroll Management</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.DynamicBankrollManagement"><code class="docutils literal notranslate"><span class="pre">DynamicBankrollManagement</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.DynamicBankrollManagement.calculate_max_entry_price"><code class="docutils literal notranslate"><span class="pre">DynamicBankrollManagement.calculate_max_entry_price()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.DynamicBankrollManagement.evaluate"><code class="docutils literal notranslate"><span class="pre">DynamicBankrollManagement.evaluate()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.DynamicBankrollManagement.get_drawdown_factor"><code class="docutils literal notranslate"><span class="pre">DynamicBankrollManagement.get_drawdown_factor()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.DynamicBankrollManagement.get_probability_factor"><code class="docutils literal notranslate"><span class="pre">DynamicBankrollManagement.get_probability_factor()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.DynamicBankrollManagement.get_streak_factor"><code class="docutils literal notranslate"><span class="pre">DynamicBankrollManagement.get_streak_factor()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.DynamicBankrollManagement.get_volatility_factor"><code class="docutils literal notranslate"><span class="pre">DynamicBankrollManagement.get_volatility_factor()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.DynamicBankrollManagement.record_result"><code class="docutils literal notranslate"><span class="pre">DynamicBankrollManagement.record_result()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../binary_strategies.html#kelly-criterion">Kelly Criterion</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.kelly.KellyCriterion"><code class="docutils literal notranslate"><span class="pre">KellyCriterion</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.kelly.KellyCriterion.calculate_max_entry_price"><code class="docutils literal notranslate"><span class="pre">KellyCriterion.calculate_max_entry_price()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.kelly.KellyCriterion.evaluate"><code class="docutils literal notranslate"><span class="pre">KellyCriterion.evaluate()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../binary_strategies.html#fractional-kelly-criterion">Fractional Kelly Criterion</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.kelly.FractionalKellyCriterion"><code class="docutils literal notranslate"><span class="pre">FractionalKellyCriterion</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.kelly.FractionalKellyCriterion.calculate_max_entry_price"><code class="docutils literal notranslate"><span class="pre">FractionalKellyCriterion.calculate_max_entry_price()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.kelly.FractionalKellyCriterion.evaluate"><code class="docutils literal notranslate"><span class="pre">FractionalKellyCriterion.evaluate()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../binary_strategies.html#drawdown-adjusted-kelly">Drawdown-Adjusted Kelly</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.kelly.DrawdownAdjustedKelly"><code class="docutils literal notranslate"><span class="pre">DrawdownAdjustedKelly</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.kelly.DrawdownAdjustedKelly.calculate_max_entry_price"><code class="docutils literal notranslate"><span class="pre">DrawdownAdjustedKelly.calculate_max_entry_price()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.kelly.DrawdownAdjustedKelly.evaluate"><code class="docutils literal notranslate"><span class="pre">DrawdownAdjustedKelly.evaluate()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../binary_strategies.html#optimalf">OptimalF</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.OptimalF"><code class="docutils literal notranslate"><span class="pre">OptimalF</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.OptimalF.calculate_max_entry_price"><code class="docutils literal notranslate"><span class="pre">OptimalF.calculate_max_entry_price()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.OptimalF.evaluate"><code class="docutils literal notranslate"><span class="pre">OptimalF.evaluate()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../binary_strategies.html#merton-share">Merton Share</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.MertonShare"><code class="docutils literal notranslate"><span class="pre">MertonShare</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.MertonShare.calculate_max_entry_price"><code class="docutils literal notranslate"><span class="pre">MertonShare.calculate_max_entry_price()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../binary_strategies.html#keeks.binary_strategies.simple.MertonShare.evaluate"><code class="docutils literal notranslate"><span class="pre">MertonShare.evaluate()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../simulators.html">Simulators</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../simulators.html#repeated-binary-simulator">Repeated Binary Simulator</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../simulators.html#keeks.simulators.repeated_binary.RepeatedBinarySimulator"><code class="docutils literal notranslate"><span class="pre">RepeatedBinarySimulator</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../simulators.html#keeks.simulators.repeated_binary.RepeatedBinarySimulator.evaluate_strategy"><code class="docutils literal notranslate"><span class="pre">RepeatedBinarySimulator.evaluate_strategy()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../simulators.html#random-binary-simulator">Random Binary Simulator</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../simulators.html#keeks.simulators.random_binary.RandomBinarySimulator"><code class="docutils literal notranslate"><span class="pre">RandomBinarySimulator</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../simulators.html#keeks.simulators.random_binary.RandomBinarySimulator.evaluate_strategy"><code class="docutils literal notranslate"><span class="pre">RandomBinarySimulator.evaluate_strategy()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../simulators.html#random-uncertain-binary-simulator">Random Uncertain Binary Simulator</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../simulators.html#keeks.simulators.random_uncertain_binary.RandomUncertainBinarySimulator"><code class="docutils literal notranslate"><span class="pre">RandomUncertainBinarySimulator</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../simulators.html#keeks.simulators.random_uncertain_binary.RandomUncertainBinarySimulator.evaluate_strategy"><code class="docutils literal notranslate"><span class="pre">RandomUncertainBinarySimulator.evaluate_strategy()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../bankroll.html">Bankroll</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../bankroll.html#exceptions">Exceptions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../utils.html">Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../utils.html#keeks.utils.RuinError"><code class="docutils literal notranslate"><span class="pre">RuinError</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../utils.html#keeks.utils.crra_utility"><code class="docutils literal notranslate"><span class="pre">crra_utility()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../utils.html#keeks.utils.expected_utility"><code class="docutils literal notranslate"><span class="pre">expected_utility()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../utils.html#keeks.utils.find_indifference_price"><code class="docutils literal notranslate"><span class="pre">find_indifference_price()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../utils.html#exceptions">Exceptions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../utils.html#id0"><code class="docutils literal notranslate"><span class="pre">RuinError</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #1a1a1a" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">keeks</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">keeks.binary_strategies.simple</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for keeks.binary_strategies.simple</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">keeks.binary_strategies.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseStrategy</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;willmcginnis&quot;</span>


<div class="viewcode-block" id="NaiveStrategy"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.NaiveStrategy">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">NaiveStrategy</span><span class="p">(</span><span class="n">BaseStrategy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple betting strategy that bets based on expected value.</span>

<span class="sd">    This strategy calculates the expected value of a bet and bets a fixed</span>
<span class="sd">    fraction of the bankroll if the expected value is positive.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    payoff : float</span>
<span class="sd">        The amount won per unit bet on a successful outcome.</span>
<span class="sd">    loss : float</span>
<span class="sd">        The amount lost per unit bet on an unsuccessful outcome.</span>
<span class="sd">    transaction_cost : float</span>
<span class="sd">        The fixed cost per transaction, regardless of outcome.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payoff</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">transaction_cost</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the NaiveStrategy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        payoff : float</span>
<span class="sd">            The amount won per unit bet on a successful outcome.</span>
<span class="sd">        loss : float</span>
<span class="sd">            The amount lost per unit bet on an unsuccessful outcome.</span>
<span class="sd">        transaction_cost : float</span>
<span class="sd">            The fixed cost per transaction, regardless of outcome.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">payoff</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">transaction_cost</span><span class="p">)</span>

<div class="viewcode-block" id="NaiveStrategy.evaluate"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.NaiveStrategy.evaluate">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probability</span><span class="p">,</span> <span class="n">current_bankroll</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the bet size based on expected value.</span>

<span class="sd">        The expected value is calculated as:</span>
<span class="sd">        EV = (probability * payoff) - ((1 - probability) * loss) - transaction_cost</span>

<span class="sd">        If EV is positive, bet a fixed fraction of the bankroll.</span>
<span class="sd">        If EV is negative, do not bet.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        probability : float</span>
<span class="sd">            The probability of a successful outcome, typically between 0 and 1.</span>
<span class="sd">        current_bankroll : float</span>
<span class="sd">            The current bankroll amount.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The proportion of the bankroll to bet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate expected value</span>
        <span class="n">expected_value</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">probability</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">payoff</span><span class="p">)</span>
            <span class="o">-</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">probability</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_cost</span>
        <span class="p">)</span>

        <span class="c1"># If expected value is negative, do not bet</span>
        <span class="k">if</span> <span class="n">expected_value</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="c1"># Calculate bet size based on expected value</span>
        <span class="n">bet_size</span> <span class="o">=</span> <span class="n">expected_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">payoff</span>

        <span class="c1"># Ensure we never bet more than would result in negative bankroll</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bet_size</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_max_safe_bet</span><span class="p">(</span><span class="n">current_bankroll</span><span class="p">))</span></div>

<div class="viewcode-block" id="NaiveStrategy.calculate_max_entry_price"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.NaiveStrategy.calculate_max_entry_price">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_max_entry_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">current_wealth</span><span class="p">,</span>
                                  <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">max_search_fraction</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate maximum price willing to pay for a one-time gamble.</span>

<span class="sd">        Naive strategy is risk-neutral and simply pays the expected value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        outcomes : array-like</span>
<span class="sd">            The possible payoffs from the gamble</span>
<span class="sd">        probabilities : array-like</span>
<span class="sd">            The probability of each outcome (must sum to â‰¤ 1)</span>
<span class="sd">        current_wealth : float</span>
<span class="sd">            Current wealth before the gamble</span>
<span class="sd">        tolerance : float, default=0.01</span>
<span class="sd">            Convergence tolerance (unused, kept for API consistency)</span>
<span class="sd">        max_search_fraction : float, default=0.5</span>
<span class="sd">            Maximum fraction of wealth to consider as upper bound (ignored in this method)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Maximum price willing to pay (the expected value)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Naive strategy is risk-neutral: willing to pay exactly the expected value.</span>
<span class="sd">        This is the classic &quot;expected value maximizer&quot; that doesn&#39;t account for risk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

        <span class="c1"># Suppress unused parameter warning - kept for API consistency</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">tolerance</span>

        <span class="n">outcomes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">outcomes</span><span class="p">)</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>

        <span class="c1"># Calculate expected value</span>
        <span class="n">expected_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">probabilities</span> <span class="o">*</span> <span class="n">outcomes</span><span class="p">)</span>

        <span class="c1"># For naive strategy, willing to pay expected value</span>
        <span class="c1"># This can be infinite (e.g., St. Petersburg paradox)</span>
        <span class="c1"># We cap at current_wealth for practical reasons</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">current_wealth</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">expected_value</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="FixedFractionStrategy"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.FixedFractionStrategy">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">FixedFractionStrategy</span><span class="p">(</span><span class="n">BaseStrategy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple strategy that bets a fixed percentage of the bankroll.</span>

<span class="sd">    This strategy ignores probabilities and odds completely, and simply</span>
<span class="sd">    wagers a fixed fraction of the bankroll. It can be used as a baseline</span>
<span class="sd">    for comparison or as a simple approach for risk management.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fraction : float</span>
<span class="sd">        The fixed fraction of the bankroll to bet (between 0 and 1).</span>
<span class="sd">    payoff : float</span>
<span class="sd">        The amount won per unit bet on a successful outcome.</span>
<span class="sd">    loss : float</span>
<span class="sd">        The amount lost per unit bet on an unsuccessful outcome.</span>
<span class="sd">    transaction_cost : float, default=0</span>
<span class="sd">        The fixed cost per transaction, regardless of outcome.</span>
<span class="sd">    min_probability : float, default=0.5</span>
<span class="sd">        The minimum probability required to place a bet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fraction</span><span class="p">,</span> <span class="n">payoff</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">transaction_cost</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_probability</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the FixedFractionStrategy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fraction : float</span>
<span class="sd">            The fixed fraction of the bankroll to bet (between 0 and 1).</span>
<span class="sd">        payoff : float</span>
<span class="sd">            The amount won per unit bet on a successful outcome.</span>
<span class="sd">        loss : float</span>
<span class="sd">            The amount lost per unit bet on an unsuccessful outcome.</span>
<span class="sd">        transaction_cost : float, default=0</span>
<span class="sd">            The fixed cost per transaction, regardless of outcome.</span>
<span class="sd">        min_probability : float, default=0.5</span>
<span class="sd">            The minimum probability required to place a bet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">fraction</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Fraction must be between 0 and 1&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">min_probability</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Minimum probability must be between 0 and 1&quot;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">payoff</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">transaction_cost</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fraction</span> <span class="o">=</span> <span class="n">fraction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_probability</span> <span class="o">=</span> <span class="n">min_probability</span>

<div class="viewcode-block" id="FixedFractionStrategy.evaluate"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.FixedFractionStrategy.evaluate">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probability</span><span class="p">,</span> <span class="n">current_bankroll</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the fixed fraction if the probability meets the minimum threshold.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        probability : float</span>
<span class="sd">            The probability of a successful outcome, typically between 0 and 1.</span>
<span class="sd">        current_bankroll : float</span>
<span class="sd">            The current bankroll amount.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The fixed fraction if probability &gt;= min_probability, otherwise 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">probability</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_probability</span><span class="p">:</span>
            <span class="c1"># Ensure we never bet more than would result in negative bankroll</span>
            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fraction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_max_safe_bet</span><span class="p">(</span><span class="n">current_bankroll</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span></div>

<div class="viewcode-block" id="FixedFractionStrategy.calculate_max_entry_price"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.FixedFractionStrategy.calculate_max_entry_price">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_max_entry_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">current_wealth</span><span class="p">,</span>
                                  <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">max_search_fraction</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate maximum price willing to pay for a one-time gamble.</span>

<span class="sd">        Fixed fraction strategy simply pays a fixed fraction of current wealth.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        outcomes : array-like</span>
<span class="sd">            The possible payoffs from the gamble (unused)</span>
<span class="sd">        probabilities : array-like</span>
<span class="sd">            The probability of each outcome (unused)</span>
<span class="sd">        current_wealth : float</span>
<span class="sd">            Current wealth before the gamble</span>
<span class="sd">        tolerance : float, default=0.01</span>
<span class="sd">            Convergence tolerance (unused, kept for API consistency)</span>
<span class="sd">        max_search_fraction : float, default=0.5</span>
<span class="sd">            Maximum fraction of wealth to consider as upper bound</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Maximum price willing to pay (fixed fraction of wealth)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Fixed fraction strategy doesn&#39;t analyze the gamble - it simply</span>
<span class="sd">        commits a fixed fraction of wealth regardless of the opportunity.</span>
<span class="sd">        This is a mechanical rule-based approach, not optimization-based.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Suppress unused parameter warnings - kept for API consistency</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">tolerance</span>

        <span class="c1"># Pay the fixed fraction of current wealth</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fraction</span> <span class="o">*</span> <span class="n">current_wealth</span><span class="p">,</span> <span class="n">max_search_fraction</span> <span class="o">*</span> <span class="n">current_wealth</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CPPIStrategy"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.CPPIStrategy">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">CPPIStrategy</span><span class="p">(</span><span class="n">BaseStrategy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of Constant Proportion Portfolio Insurance (CPPI) for binary betting.</span>

<span class="sd">    This strategy maintains a dynamic floor below which the bankroll should not fall,</span>
<span class="sd">    and invests a multiple of the cushion (amount above floor) in each bet.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    floor_fraction : float</span>
<span class="sd">        The fraction of initial bankroll to maintain as a floor.</span>
<span class="sd">    multiplier : float</span>
<span class="sd">        The multiplier to apply to the cushion for determining exposure.</span>
<span class="sd">    initial_bankroll : float</span>
<span class="sd">        The initial bankroll amount.</span>
<span class="sd">    payoff : float</span>
<span class="sd">        The amount won per unit bet on a successful outcome.</span>
<span class="sd">    loss : float</span>
<span class="sd">        The amount lost per unit bet on an unsuccessful outcome.</span>
<span class="sd">    transaction_cost : float</span>
<span class="sd">        The fixed cost per transaction, regardless of outcome.</span>
<span class="sd">    min_probability : float, default=0.5</span>
<span class="sd">        The minimum probability required to place a bet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">floor_fraction</span><span class="p">,</span>
        <span class="n">multiplier</span><span class="p">,</span>
        <span class="n">initial_bankroll</span><span class="p">,</span>
        <span class="n">payoff</span><span class="p">,</span>
        <span class="n">loss</span><span class="p">,</span>
        <span class="n">transaction_cost</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">min_probability</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the CPPI strategy.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">floor_fraction</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Floor fraction must be between 0 and 1&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">multiplier</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Multiplier must be greater than 0&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">initial_bankroll</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Initial bankroll must be greater than 0&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">min_probability</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Minimum probability must be between 0 and 1&quot;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">payoff</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">transaction_cost</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">floor_fraction</span> <span class="o">=</span> <span class="n">floor_fraction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">=</span> <span class="n">multiplier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">floor</span> <span class="o">=</span> <span class="n">floor_fraction</span> <span class="o">*</span> <span class="n">initial_bankroll</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_probability</span> <span class="o">=</span> <span class="n">min_probability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_bankroll</span> <span class="o">=</span> <span class="n">initial_bankroll</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_bankroll</span> <span class="o">=</span> <span class="n">initial_bankroll</span>

<div class="viewcode-block" id="CPPIStrategy.update_bankroll"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.CPPIStrategy.update_bankroll">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_bankroll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_bankroll</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the current bankroll value and adjust floor based on peak value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new_bankroll : float</span>
<span class="sd">            The current value of the bankroll.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_bankroll</span> <span class="o">=</span> <span class="n">new_bankroll</span>
        <span class="k">if</span> <span class="n">new_bankroll</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_bankroll</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peak_bankroll</span> <span class="o">=</span> <span class="n">new_bankroll</span>
            <span class="c1"># Adjust floor to maintain the same fraction of peak value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">floor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">floor_fraction</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_bankroll</span></div>

<div class="viewcode-block" id="CPPIStrategy.evaluate"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.CPPIStrategy.evaluate">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probability</span><span class="p">,</span> <span class="n">current_bankroll</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the CPPI bet size based on the cushion above the floor.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        probability : float</span>
<span class="sd">            The probability of a successful outcome, typically between 0 and 1.</span>
<span class="sd">        current_bankroll : float</span>
<span class="sd">            The current bankroll amount.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The proportion of the current bankroll to bet, or 0 if below</span>
<span class="sd">            the minimum probability threshold.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Update current bankroll</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_bankroll</span><span class="p">(</span><span class="n">current_bankroll</span><span class="p">)</span>

        <span class="c1"># Check probability threshold</span>
        <span class="k">if</span> <span class="n">probability</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_probability</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="c1"># Calculate expected value per unit bet</span>
        <span class="n">expected_value</span> <span class="o">=</span> <span class="n">probability</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">payoff</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_cost</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span>
            <span class="mi">1</span> <span class="o">-</span> <span class="n">probability</span>
        <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_cost</span><span class="p">)</span>

        <span class="c1"># If expected value is negative, don&#39;t bet</span>
        <span class="c1"># Note: We allow small positive edges (even &lt; 1%) for realistic scenarios</span>
        <span class="c1"># Professional bettors often operate with 0.5-2% edges</span>
        <span class="k">if</span> <span class="n">expected_value</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="c1"># Calculate the cushion (amount above the floor)</span>
        <span class="n">cushion</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">current_bankroll</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">floor</span><span class="p">)</span>

        <span class="c1"># Calculate the exposure (amount to bet)</span>
        <span class="c1"># Scale the multiplier by the expected value to be more conservative</span>
        <span class="c1"># when the edge is smaller</span>
        <span class="n">adjusted_multiplier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">expected_value</span><span class="p">)</span>
        <span class="n">exposure</span> <span class="o">=</span> <span class="n">adjusted_multiplier</span> <span class="o">*</span> <span class="n">cushion</span>

        <span class="c1"># Convert to a proportion of the current bankroll</span>
        <span class="k">if</span> <span class="n">current_bankroll</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="c1"># Calculate proportion</span>
        <span class="n">proportion</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">exposure</span> <span class="o">/</span> <span class="n">current_bankroll</span><span class="p">)</span>

        <span class="c1"># Adjust for transaction costs and ensure we don&#39;t risk going below floor</span>
        <span class="k">if</span> <span class="n">proportion</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Calculate the maximum bet that ensures we stay above the floor</span>
            <span class="c1"># even in the worst case (loss + transaction cost)</span>
            <span class="n">max_floor_bet</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_bankroll</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">floor</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">current_bankroll</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_cost</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Get the maximum safe bet considering ruin</span>
            <span class="n">max_safe_bet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_max_safe_bet</span><span class="p">(</span><span class="n">current_bankroll</span><span class="p">)</span>

            <span class="c1"># Take the minimum of all constraints</span>
            <span class="n">proportion</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">proportion</span><span class="p">,</span> <span class="n">max_floor_bet</span><span class="p">,</span> <span class="n">max_safe_bet</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">proportion</span><span class="p">)</span></div>

<div class="viewcode-block" id="CPPIStrategy.calculate_max_entry_price"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.CPPIStrategy.calculate_max_entry_price">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_max_entry_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">current_wealth</span><span class="p">,</span>
                                  <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">max_search_fraction</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate maximum price willing to pay for a one-time gamble.</span>

<span class="sd">        CPPI protects a floor value, so entry price is based on the cushion</span>
<span class="sd">        above the floor, scaled by the multiplier.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        outcomes : array-like</span>
<span class="sd">            The possible payoffs from the gamble (unused in basic calculation)</span>
<span class="sd">        probabilities : array-like</span>
<span class="sd">            The probability of each outcome (unused in basic calculation)</span>
<span class="sd">        current_wealth : float</span>
<span class="sd">            Current wealth before the gamble</span>
<span class="sd">        tolerance : float, default=0.01</span>
<span class="sd">            Convergence tolerance (unused, kept for API consistency)</span>
<span class="sd">        max_search_fraction : float, default=0.5</span>
<span class="sd">            Maximum fraction of wealth to consider as upper bound</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Maximum price willing to pay (based on cushion above floor)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        CPPI maintains a floor value and bets a multiple of the cushion.</span>
<span class="sd">        For entry price, we apply the same logic: pay multiplier Ã— cushion,</span>
<span class="sd">        but never more than the cushion itself (to maintain floor).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Suppress unused parameter warnings</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">tolerance</span>

        <span class="c1"># Update internal state with current wealth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_bankroll</span><span class="p">(</span><span class="n">current_wealth</span><span class="p">)</span>

        <span class="c1"># Calculate cushion above floor</span>
        <span class="n">cushion</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">current_wealth</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">floor</span><span class="p">)</span>

        <span class="c1"># Pay up to multiplier Ã— cushion, but capped at the cushion itself</span>
        <span class="c1"># (can&#39;t pay more than cushion without violating floor)</span>
        <span class="n">max_price</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">*</span> <span class="n">cushion</span><span class="p">,</span> <span class="n">cushion</span><span class="p">)</span>

        <span class="c1"># Also respect max_search_fraction</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_price</span><span class="p">,</span> <span class="n">max_search_fraction</span> <span class="o">*</span> <span class="n">current_wealth</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DynamicBankrollManagement"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.DynamicBankrollManagement">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">DynamicBankrollManagement</span><span class="p">(</span><span class="n">BaseStrategy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dynamic bankroll management strategy that adjusts bet sizes based on performance.</span>

<span class="sd">    This strategy adjusts the base bet fraction based on:</span>
<span class="sd">    1. Recent performance (win/loss streak)</span>
<span class="sd">    2. Volatility of returns</span>
<span class="sd">    3. Current drawdown level</span>
<span class="sd">    4. Probability of success</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    base_fraction : float</span>
<span class="sd">        The base fraction of bankroll to bet.</span>
<span class="sd">    payoff : float</span>
<span class="sd">        The amount won per unit bet on a successful outcome.</span>
<span class="sd">    loss : float</span>
<span class="sd">        The amount lost per unit bet on an unsuccessful outcome.</span>
<span class="sd">    transaction_cost : float</span>
<span class="sd">        The fixed cost per transaction, regardless of outcome.</span>
<span class="sd">    window_size : int, default=10</span>
<span class="sd">        The number of recent results to consider for adjustments.</span>
<span class="sd">    max_fraction : float, default=0.2</span>
<span class="sd">        The maximum fraction of bankroll that can be bet.</span>
<span class="sd">    min_fraction : float, default=0.05</span>
<span class="sd">        The minimum fraction of bankroll to bet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">base_fraction</span><span class="p">,</span>
        <span class="n">payoff</span><span class="p">,</span>
        <span class="n">loss</span><span class="p">,</span>
        <span class="n">transaction_cost</span><span class="p">,</span>
        <span class="n">window_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">max_fraction</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">min_fraction</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the DynamicBankrollManagement strategy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">base_fraction</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Base fraction must be between 0 and 1&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">window_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Window size must be positive&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">min_fraction</span> <span class="o">&lt;=</span> <span class="n">max_fraction</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Min fraction must be between 0 and max fraction, and max fraction must be between 0 and 1&quot;</span>
            <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">payoff</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">transaction_cost</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_fraction</span> <span class="o">=</span> <span class="n">base_fraction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">=</span> <span class="n">window_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_fraction</span> <span class="o">=</span> <span class="n">max_fraction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_fraction</span> <span class="o">=</span> <span class="n">min_fraction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_bankroll</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_bankroll</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_bankroll</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="DynamicBankrollManagement.record_result"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.DynamicBankrollManagement.record_result">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">record_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">won</span><span class="p">,</span> <span class="n">return_pct</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Record the result of a bet.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        won : bool</span>
<span class="sd">            Whether the bet was won.</span>
<span class="sd">        return_pct : float, optional</span>
<span class="sd">            The return percentage of the bet. If not provided, calculated from won/loss.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">return_pct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">return_pct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">payoff</span> <span class="k">if</span> <span class="n">won</span> <span class="k">else</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">return_pct</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="DynamicBankrollManagement.get_streak_factor"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.DynamicBankrollManagement.get_streak_factor">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_streak_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the adjustment factor based on recent performance.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span>

        <span class="c1"># Scale factor by window size to make smaller windows more responsive</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span>

        <span class="n">wins</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">losses</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>  <span class="c1"># Maximum boost for all wins</span>
        <span class="k">if</span> <span class="n">wins</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>  <span class="c1"># Maximum reduction for all losses</span>

        <span class="n">win_ratio</span> <span class="o">=</span> <span class="n">wins</span> <span class="o">/</span> <span class="p">(</span><span class="n">wins</span> <span class="o">+</span> <span class="n">losses</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="p">((</span><span class="n">win_ratio</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span></div>

<div class="viewcode-block" id="DynamicBankrollManagement.get_volatility_factor"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.DynamicBankrollManagement.get_volatility_factor">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_volatility_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the adjustment factor based on return volatility.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span>

        <span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
        <span class="n">volatility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">volatility</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span>

        <span class="c1"># Scale factor by window size to make smaller windows more responsive</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">volatility</span> <span class="o">*</span> <span class="n">scale</span><span class="p">))</span></div>

<div class="viewcode-block" id="DynamicBankrollManagement.get_drawdown_factor"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.DynamicBankrollManagement.get_drawdown_factor">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_drawdown_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the adjustment factor based on current drawdown.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_bankroll</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_bankroll</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span>

        <span class="n">drawdown</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_bankroll</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_bankroll</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">drawdown</span><span class="p">)</span></div>

<div class="viewcode-block" id="DynamicBankrollManagement.get_probability_factor"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.DynamicBankrollManagement.get_probability_factor">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_probability_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probability</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the adjustment factor based on probability.&quot;&quot;&quot;</span>
        <span class="c1"># Only apply probability factor if we have some results</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span>

        <span class="c1"># Scale linearly from 0.5 at 50% probability to 1.5 at 100% probability</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">probability</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)))</span></div>

<div class="viewcode-block" id="DynamicBankrollManagement.evaluate"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.DynamicBankrollManagement.evaluate">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probability</span><span class="p">,</span> <span class="n">current_bankroll</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the bet size based on all adjustment factors.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        probability : float</span>
<span class="sd">            The probability of a successful outcome.</span>
<span class="sd">        current_bankroll : float</span>
<span class="sd">            The current bankroll amount.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The proportion of the current bankroll to bet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize or update bankroll tracking</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_bankroll</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial_bankroll</span> <span class="o">=</span> <span class="n">current_bankroll</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peak_bankroll</span> <span class="o">=</span> <span class="n">current_bankroll</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_bankroll</span> <span class="o">=</span> <span class="n">current_bankroll</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_bankroll</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_bankroll</span><span class="p">,</span> <span class="n">current_bankroll</span><span class="p">)</span>

        <span class="c1"># Get all adjustment factors</span>
        <span class="n">streak_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_streak_factor</span><span class="p">()</span>
        <span class="n">volatility_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volatility_factor</span><span class="p">()</span>
        <span class="n">drawdown_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_drawdown_factor</span><span class="p">()</span>
        <span class="n">probability_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_probability_factor</span><span class="p">(</span><span class="n">probability</span><span class="p">)</span>

        <span class="c1"># Combine all factors</span>
        <span class="n">combined_factor</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">streak_factor</span> <span class="o">*</span> <span class="n">volatility_factor</span> <span class="o">*</span> <span class="n">drawdown_factor</span> <span class="o">*</span> <span class="n">probability_factor</span>
        <span class="p">)</span>

        <span class="c1"># Calculate adjusted bet size</span>
        <span class="n">bet_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_fraction</span> <span class="o">*</span> <span class="n">combined_factor</span>

        <span class="c1"># Ensure bet size is within bounds</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_fraction</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_fraction</span><span class="p">,</span> <span class="n">bet_size</span><span class="p">))</span></div>

<div class="viewcode-block" id="DynamicBankrollManagement.calculate_max_entry_price"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.DynamicBankrollManagement.calculate_max_entry_price">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_max_entry_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">current_wealth</span><span class="p">,</span>
                                  <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">max_search_fraction</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate maximum price willing to pay for a one-time gamble.</span>

<span class="sd">        Dynamic strategy adjusts based on history, but for a one-time decision</span>
<span class="sd">        with no history, we use the base fraction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        outcomes : array-like</span>
<span class="sd">            The possible payoffs from the gamble (unused)</span>
<span class="sd">        probabilities : array-like</span>
<span class="sd">            The probability of each outcome (unused)</span>
<span class="sd">        current_wealth : float</span>
<span class="sd">            Current wealth before the gamble</span>
<span class="sd">        tolerance : float, default=0.01</span>
<span class="sd">            Convergence tolerance (unused, kept for API consistency)</span>
<span class="sd">        max_search_fraction : float, default=0.5</span>
<span class="sd">            Maximum fraction of wealth to consider as upper bound</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Maximum price willing to pay (base fraction of wealth)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Dynamic strategy normally adjusts based on recent performance history.</span>
<span class="sd">        For a one-time decision with no history, we fall back to the base_fraction.</span>
<span class="sd">        This represents a neutral starting point before dynamic adjustments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Suppress unused parameter warnings</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">tolerance</span>

        <span class="c1"># Use base fraction since we have no history for a one-time decision</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_fraction</span> <span class="o">*</span> <span class="n">current_wealth</span><span class="p">,</span> <span class="n">max_search_fraction</span> <span class="o">*</span> <span class="n">current_wealth</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="OptimalF"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.OptimalF">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">OptimalF</span><span class="p">(</span><span class="n">BaseStrategy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of the Optimal f strategy for binary betting.</span>

<span class="sd">    This strategy calculates the optimal fraction of bankroll to bet based on</span>
<span class="sd">    the win rate and payoff ratio. It&#39;s similar to Kelly but uses a different</span>
<span class="sd">    approach to risk management.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    payoff : float</span>
<span class="sd">        The amount won per unit bet on a successful outcome.</span>
<span class="sd">    loss : float</span>
<span class="sd">        The amount lost per unit bet on an unsuccessful outcome.</span>
<span class="sd">    transaction_cost : float</span>
<span class="sd">        The fixed cost per transaction, regardless of outcome.</span>
<span class="sd">    win_rate : float</span>
<span class="sd">        The historical or expected win rate (between 0 and 1).</span>
<span class="sd">    max_risk_fraction : float, default=0.2</span>
<span class="sd">        The maximum fraction of bankroll that can be risked on a single bet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payoff</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">transaction_cost</span><span class="p">,</span> <span class="n">win_rate</span><span class="p">,</span> <span class="n">max_risk_fraction</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the OptimalF strategy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        payoff : float</span>
<span class="sd">            The amount won per unit bet on a successful outcome.</span>
<span class="sd">        loss : float</span>
<span class="sd">            The amount lost per unit bet on an unsuccessful outcome.</span>
<span class="sd">        transaction_cost : float</span>
<span class="sd">            The fixed cost per transaction, regardless of outcome.</span>
<span class="sd">        win_rate : float</span>
<span class="sd">            The historical or expected win rate (between 0 and 1).</span>
<span class="sd">        max_risk_fraction : float, default=0.2</span>
<span class="sd">            The maximum fraction of bankroll that can be risked on a single bet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">win_rate</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Win rate must be between 0 and 1&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">max_risk_fraction</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Maximum risk fraction must be between 0 and 1&quot;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">payoff</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">transaction_cost</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win_rate</span> <span class="o">=</span> <span class="n">win_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_fraction</span> <span class="o">=</span> <span class="n">max_risk_fraction</span>

<div class="viewcode-block" id="OptimalF.evaluate"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.OptimalF.evaluate">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probability</span><span class="p">,</span> <span class="n">current_bankroll</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the optimal f bet size based on win rate and payoff ratio.</span>

<span class="sd">        This implementation follows Ralph Vince&#39;s approach to Optimal f, which</span>
<span class="sd">        is based on maximizing the terminal wealth relative (TWR) for a given</span>
<span class="sd">        risk-to-reward profile.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        probability : float</span>
<span class="sd">            The probability of a successful outcome, typically between 0 and 1.</span>
<span class="sd">        current_bankroll : float</span>
<span class="sd">            The current bankroll amount.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The optimal proportion of the bankroll to bet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">probability</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>  <span class="c1"># Use 0.5 as default minimum probability</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="c1"># Use the provided probability to adjust our expectations</span>
        <span class="c1"># If no specific edge is known, the win_rate will be used directly</span>
        <span class="n">adjusted_win_rate</span> <span class="o">=</span> <span class="n">probability</span> <span class="k">if</span> <span class="n">probability</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">win_rate</span>
        <span class="n">adjusted_loss_rate</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">adjusted_win_rate</span>

        <span class="c1"># Calculate the risk-to-reward ratio (R-multiple)</span>
        <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">payoff</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_cost</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_cost</span>

        <span class="c1"># If transaction costs make the bet unprofitable, don&#39;t bet</span>
        <span class="k">if</span> <span class="n">reward</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="c1"># Calculate optimal f using the formula:</span>
        <span class="c1"># f* = W - (1-W)/(R/L) where W is win rate, R is reward, L is risk</span>
        <span class="c1"># This is more aligned with Ralph Vince&#39;s approach</span>
        <span class="n">optimal_f</span> <span class="o">=</span> <span class="n">adjusted_win_rate</span> <span class="o">-</span> <span class="p">(</span><span class="n">adjusted_loss_rate</span> <span class="o">/</span> <span class="p">(</span><span class="n">reward</span> <span class="o">/</span> <span class="n">risk</span><span class="p">))</span>

        <span class="c1"># Cap at our maximum risk fraction</span>
        <span class="n">optimal_f</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">optimal_f</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_fraction</span><span class="p">)</span>

        <span class="c1"># Ensure we never bet more than would result in negative bankroll</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">optimal_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_max_safe_bet</span><span class="p">(</span><span class="n">current_bankroll</span><span class="p">))</span></div>

<div class="viewcode-block" id="OptimalF.calculate_max_entry_price"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.OptimalF.calculate_max_entry_price">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_max_entry_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">current_wealth</span><span class="p">,</span>
                                  <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">max_search_fraction</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate maximum price willing to pay for a one-time gamble.</span>

<span class="sd">        Optimal F maximizes geometric growth (like Kelly), so we use log utility.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        outcomes : array-like</span>
<span class="sd">            The possible payoffs from the gamble</span>
<span class="sd">        probabilities : array-like</span>
<span class="sd">            The probability of each outcome (must sum to â‰¤ 1)</span>
<span class="sd">        current_wealth : float</span>
<span class="sd">            Current wealth before the gamble</span>
<span class="sd">        tolerance : float, default=0.01</span>
<span class="sd">            Convergence tolerance for binary search</span>
<span class="sd">        max_search_fraction : float, default=0.5</span>
<span class="sd">            Maximum fraction of wealth to consider as upper bound</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Maximum price willing to pay for the gamble</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Optimal F, like Kelly Criterion, aims to maximize geometric growth,</span>
<span class="sd">        which corresponds to log utility (Î³=1.0).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">keeks.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_indifference_price</span>

        <span class="k">return</span> <span class="n">find_indifference_price</span><span class="p">(</span>
            <span class="n">outcomes</span><span class="o">=</span><span class="n">outcomes</span><span class="p">,</span>
            <span class="n">probabilities</span><span class="o">=</span><span class="n">probabilities</span><span class="p">,</span>
            <span class="n">current_wealth</span><span class="o">=</span><span class="n">current_wealth</span><span class="p">,</span>
            <span class="n">risk_aversion</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>  <span class="c1"># Optimal F uses log utility like Kelly</span>
            <span class="n">tolerance</span><span class="o">=</span><span class="n">tolerance</span><span class="p">,</span>
            <span class="n">max_search_fraction</span><span class="o">=</span><span class="n">max_search_fraction</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="MertonShare"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.MertonShare">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">MertonShare</span><span class="p">(</span><span class="n">BaseStrategy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of the Merton Share strategy using CRRA utility.</span>

<span class="sd">    This strategy is based on Robert Merton&#39;s portfolio optimization problem</span>
<span class="sd">    with Constant Relative Risk Aversion (CRRA) utility. The optimal fraction</span>
<span class="sd">    to invest is proportional to the expected excess return divided by the</span>
<span class="sd">    product of risk aversion and variance.</span>

<span class="sd">    The formula is: f* = Î¼ / (Î³ Ã— ÏƒÂ²)</span>

<span class="sd">    Where:</span>
<span class="sd">    - f* is the optimal fraction of wealth to invest</span>
<span class="sd">    - Î¼ is the expected excess return (return above risk-free rate)</span>
<span class="sd">    - Î³ (gamma) is the coefficient of relative risk aversion</span>
<span class="sd">    - ÏƒÂ² (sigma squared) is the variance of returns</span>

<span class="sd">    For binary betting, we adapt this by:</span>
<span class="sd">    - Expected return is calculated from probability and payoff/loss ratios</span>
<span class="sd">    - Variance is estimated from the binary outcome distribution</span>
<span class="sd">    - Transaction costs are incorporated into the expected return</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    payoff : float</span>
<span class="sd">        The amount won per unit bet on a successful outcome.</span>
<span class="sd">    loss : float</span>
<span class="sd">        The amount lost per unit bet on an unsuccessful outcome.</span>
<span class="sd">    transaction_cost : float</span>
<span class="sd">        The fixed cost per transaction, regardless of outcome.</span>
<span class="sd">    risk_aversion : float, default=2.0</span>
<span class="sd">        The coefficient of relative risk aversion (Î³). Common values:</span>
<span class="sd">        - 1.0: Low risk aversion</span>
<span class="sd">        - 2.0: Moderate risk aversion (most common empirical estimate)</span>
<span class="sd">        - 3.0-5.0: High risk aversion</span>
<span class="sd">    min_probability : float, default=0.5</span>
<span class="sd">        The minimum probability required to place a bet.</span>
<span class="sd">    max_fraction : float, default=1.0</span>
<span class="sd">        The maximum fraction of bankroll to bet (safety cap).</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Merton, R. C. (1969). &quot;Lifetime Portfolio Selection under Uncertainty:</span>
<span class="sd">           The Continuous-Time Case&quot;. The Review of Economics and Statistics.</span>
<span class="sd">    .. [2] https://elmwealth.com/merton-share-derivations/</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">payoff</span><span class="p">,</span>
        <span class="n">loss</span><span class="p">,</span>
        <span class="n">transaction_cost</span><span class="p">,</span>
        <span class="n">risk_aversion</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
        <span class="n">min_probability</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">max_fraction</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the MertonShare strategy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        payoff : float</span>
<span class="sd">            The amount won per unit bet on a successful outcome.</span>
<span class="sd">        loss : float</span>
<span class="sd">            The amount lost per unit bet on an unsuccessful outcome.</span>
<span class="sd">        transaction_cost : float</span>
<span class="sd">            The fixed cost per transaction, regardless of outcome.</span>
<span class="sd">        risk_aversion : float, default=2.0</span>
<span class="sd">            The coefficient of relative risk aversion.</span>
<span class="sd">        min_probability : float, default=0.5</span>
<span class="sd">            The minimum probability required to place a bet.</span>
<span class="sd">        max_fraction : float, default=1.0</span>
<span class="sd">            The maximum fraction of bankroll to bet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">risk_aversion</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Risk aversion must be greater than 0&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">min_probability</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Minimum probability must be between 0 and 1&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">max_fraction</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Maximum fraction must be between 0 and 1&quot;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">payoff</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">transaction_cost</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_aversion</span> <span class="o">=</span> <span class="n">risk_aversion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_probability</span> <span class="o">=</span> <span class="n">min_probability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_fraction</span> <span class="o">=</span> <span class="n">max_fraction</span>

<div class="viewcode-block" id="MertonShare.evaluate"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.MertonShare.evaluate">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probability</span><span class="p">,</span> <span class="n">current_bankroll</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the Merton Share bet size using CRRA utility.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        probability : float</span>
<span class="sd">            The probability of a successful outcome, typically between 0 and 1.</span>
<span class="sd">        current_bankroll : float</span>
<span class="sd">            The current bankroll amount.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The optimal proportion of the bankroll to bet based on Merton&#39;s formula.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">probability</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_probability</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="c1"># Calculate expected return accounting for transaction costs</span>
        <span class="c1"># Expected return = p * (payoff - tc) - (1-p) * (loss + tc)</span>
        <span class="n">expected_return</span> <span class="o">=</span> <span class="n">probability</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">payoff</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_cost</span>
        <span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">probability</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_cost</span><span class="p">)</span>

        <span class="c1"># Don&#39;t bet if expected return is non-positive</span>
        <span class="k">if</span> <span class="n">expected_return</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="c1"># Calculate variance of returns for a binary outcome</span>
        <span class="c1"># For a binary bet: Var(R) = p * (payoff)^2 + (1-p) * (-loss)^2 - E[R]^2</span>
        <span class="c1"># We use gross returns (before transaction costs) for variance calculation</span>
        <span class="n">mean_squared_return</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">probability</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">payoff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">probability</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">variance</span> <span class="o">=</span> <span class="n">mean_squared_return</span> <span class="o">-</span> <span class="p">(</span>
            <span class="n">probability</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">payoff</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">probability</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span>
        <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="c1"># Avoid division by zero</span>
        <span class="k">if</span> <span class="n">variance</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="c1"># Apply Merton&#39;s formula: f* = Î¼ / (Î³ Ã— ÏƒÂ²)</span>
        <span class="n">merton_fraction</span> <span class="o">=</span> <span class="n">expected_return</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">risk_aversion</span> <span class="o">*</span> <span class="n">variance</span><span class="p">)</span>

        <span class="c1"># Apply safety constraints</span>
        <span class="n">merton_fraction</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">merton_fraction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_fraction</span><span class="p">))</span>

        <span class="c1"># Ensure we never bet more than would result in negative bankroll</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">merton_fraction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_max_safe_bet</span><span class="p">(</span><span class="n">current_bankroll</span><span class="p">))</span></div>

<div class="viewcode-block" id="MertonShare.calculate_max_entry_price"><a class="viewcode-back" href="../../../binary_strategies.html#keeks.binary_strategies.simple.MertonShare.calculate_max_entry_price">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_max_entry_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">current_wealth</span><span class="p">,</span>
                                  <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">max_search_fraction</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate maximum price willing to pay for a one-time gamble.</span>

<span class="sd">        MertonShare is derived from CRRA utility maximization with the</span>
<span class="sd">        risk_aversion parameter (Î³) that was set during initialization.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        outcomes : array-like</span>
<span class="sd">            The possible payoffs from the gamble</span>
<span class="sd">        probabilities : array-like</span>
<span class="sd">            The probability of each outcome (must sum to â‰¤ 1)</span>
<span class="sd">        current_wealth : float</span>
<span class="sd">            Current wealth before the gamble</span>
<span class="sd">        tolerance : float, default=0.01</span>
<span class="sd">            Convergence tolerance for binary search</span>
<span class="sd">        max_search_fraction : float, default=0.5</span>
<span class="sd">            Maximum fraction of wealth to consider as upper bound</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Maximum price willing to pay for the gamble</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Uses the risk_aversion (Î³) parameter set during initialization.</span>
<span class="sd">        For Î³=1.0, this is equivalent to Kelly Criterion (log utility).</span>
<span class="sd">        Higher Î³ values indicate more risk aversion and lower willing payments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">keeks.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_indifference_price</span>

        <span class="k">return</span> <span class="n">find_indifference_price</span><span class="p">(</span>
            <span class="n">outcomes</span><span class="o">=</span><span class="n">outcomes</span><span class="p">,</span>
            <span class="n">probabilities</span><span class="o">=</span><span class="n">probabilities</span><span class="p">,</span>
            <span class="n">current_wealth</span><span class="o">=</span><span class="n">current_wealth</span><span class="p">,</span>
            <span class="n">risk_aversion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">risk_aversion</span><span class="p">,</span>  <span class="c1"># Use the strategy&#39;s Î³ parameter</span>
            <span class="n">tolerance</span><span class="o">=</span><span class="n">tolerance</span><span class="p">,</span>
            <span class="n">max_search_fraction</span><span class="o">=</span><span class="n">max_search_fraction</span>
        <span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Will McGinnis.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>